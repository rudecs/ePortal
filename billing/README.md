## Общее описание
Основные компонеты системы:
* Воркер для получения usage данных, вычисления биллинговых единиц и сохранения их в удобном для аггрегации виде
* API
  * Обновление кода расчета стоимости у ProductInstance
  * Запрос на получение данных о начислениях по биллинговым единицам за период по клиенту

## Воркер обработки usage
Общий алгоритм:
1. Каждый час в 15 минут происходит запрос к usage за предыдущий час
2. Полученные записи usage группируются по product_instance_id
3. Каждая запись usage помещается в очередь обработки, которую параллельно обрабатывают воркеры Sidekiq в несколько потоков (8 или 16, легко масштабируется при необходимости)
4. У записи usage берется product_instance_id и по нему находится код расчета стоимости. Берется актуальная (последняя) версия кода расчета стоимости product_instance.
5. На данный момент из доступных языков кода расчета стоимости - javascript. Ожидается, что код расчета стоимости размещен в функции с названием execute_billing_code. Входящие параметры - хэш usage-записи, в том виде в котором приходит от usage-сервиса.
6. Ожидается, что код расчета стоимости возвращает результат(биллинговые единицы) вида:
```js
{ cpu: { count: 10, price: 120, currency: 'rub' },  memory: { count: 4000, price: 100, currency: 'rub' } }
```
7. Чтобы в дальнейшем группировать данные по начислениям charges по одинаковым наборам биллинговых единиц, происходит расчет дайджеста хэша биллинговых единиц. Используется алгоритм на основе md5.
8. Происходит поиск записи начислений charges за предыдущий час с таким же набором биллинговых единиц. Если такая запись есть, то у новой создаваемой записи charges поле идентификатора непрерывного отрезка времени time_sequence_uid берется из предыдущей записи. Если такой записи нет, то генерируется и присваивается новое значение time_sequence_uid.
9. Происходит запись начислений биллинговых единиц с полями для дальнейшей аггрегации billing_units_digest и time_sequence_uid
10. В случае повторного запуска расчета начислений за прошлые периоды, существующие записи начислений перезаписываются, не задваиваются.
