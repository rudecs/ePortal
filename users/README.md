# Clients

---

**Вопросы для обсуждения:**
* список прав
* реализация приглашений

---

```plantuml
class Client {
  Клиент, организация
  --
  + id
  --
  + name
  --
  + state
  active, ...
  --
  + created_at
  + updated_at
  + deleted_at
}

class User {
  Пользователь
  --
  + id
  --
  + first_name
  + last_name
  + email
  --
  + state
  + password_digest
  --
  + created_at
  + updated_at
  + deleted_at
}

class Session {
  Сессия пользователя
  --
  + user_id
  --
  + token
  уникальное поле
  --
  + created_at
  + updated_at
  + expired_at
}

class Role {
  Роль в организации
  --
  + id
  + client_id
  --
  + name
  + read_only
  true/false
  Для базовых ролей, которых
  нельзя изменять и удалять.
  + permissions
  права, поле типа hstore,
  где ключ - название действия,
  значение - true/false;
  например:
  {can_buy_product: true, ...}
  --
  + created_at
  + updated_at
  + deleted_at
}

class Profile {
  Пока что это просто
  связующая таблица
  между User и Role.
  Не несет никаких
  дополнительных функций.
  В дальнейшем может
  дополниться отделом.
  --
  + user_id
  + role_id
  --
  + created_at
  + updated_at
}

Client --{ Role
Role --{ Profile
Profile }-- User
User --{ Session
```

При **регистрации** одной транзакцией создаются:
* клиент
* админская роль для клиента
* пользователь
* связь пользователя и клиентской роли (профиль)

### Тезисы:
* У каждого пользователя должен быть как минимум один принадлежащий лично ему клиент. Он создается автоматически при регистрации пользователя.
* От лица любого клиента можно выслать приглашение любому пользователю (если он еще не приглашен). Приглашение содержит роль, через которую пользователь будет действовать от лица клиента (если приглашение будет принято). Связь пользователя и клиентской роли = профиль.
* Пользователь не выбирает, от лица какого профиля ему действовать. Если хоть одна роль из всех профилей юзера разрешает действие - авторизация запроса проходит успешно.

---

#### Немного о роутере:

При любом запросе на бек передаются два хедера:
* X-Session-Token
* X-Client-Id

При аутентификации они преобразуются в три объекта:
* user {id, ...}
* client {id, name, ...}
* permissions {can_buy_product, ...}

которые проксируются вместе с запросом до нужного микросервиса.
